---
feature: damage-calculator
type: tasks
version: 1.0.0
created: 2025-01-28
status: draft
---

# 傷害計算器 - 實作任務清單

## 📋 實作順序與任務分組

### 🔧 Phase 1: 開發環境設置

- [x] **ENV-1** 安裝 Vitest 測試框架
  - [x] 在 package.json 添加 vitest 相依套件
  - [x] 配置 vitest.config.ts 設定檔
  - [x] 設定 TypeScript 型別支援
  - [x] 建立測試目錄結構 `tests/`

### 🧮 Phase 2: 核心計算邏輯

- [x] **CALC-1** 建立傷害計算類別 `DamageCalculator`
  - [x] 定義 `DamageParameters` 介面
  - [x] 定義 `DamageCalculationResult` 介面
  - [x] 定義 `DamageCalculationStep` 介面
  - [x] 實作 `calculate()` 主要計算方法
  - [x] 實作 `calculateArmorReduction()` 護甲計算方法
  - [x] 加入計算步驟追蹤功能

- [x] **CALC-2** 實作各計算步驟
  - [x] **步驟 1**: 增加傷害計算 `(1 + Σ增加傷害)`
  - [x] **步驟 2**: 暴擊傷害計算 `(1 + 基礎暴傷 + Σ暴傷加成)`
  - [x] **步驟 3**: 護甲減免計算
    - [x] 有效穿甲率計算 `Σ穿甲效果 / (Σ穿甲效果 + 100)`
    - [x] 穿甲後護甲計算 `護甲 × (1 - 有效穿甲率)`
    - [x] 護甲減免率計算 `穿甲後護甲 / (穿甲後護甲 + 500)`
  - [x] **步驟 4**: 傷害減免計算 `(1 - Σ傷害減免)`
  - [x] **步驟 5**: 承受傷害計算 `(1 + Σ承受傷害)`

- [x] **CALC-3** 單元測試 - 計算邏輯
  - [x] 測試基礎傷害計算（無任何加成）
  - [x] 測試增加傷害計算（單項與多項）
  - [x] 測試暴擊傷害計算（基礎 + 額外加成）
  - [x] 測試護甲減免計算（有穿甲 vs 無穿甲）
  - [x] 測試穿甲效果上限（75% 上限驗證）
  - [x] 測試完整公式計算（文檔範例 1: 957.42）
  - [x] 測試完整公式計算（文檔範例 2: 1096.88）
  - [x] 測試邊界值（零值、負值、極大值）
  - [x] 測試精度（小數點後2位四捨五入）

### 🎛️ Phase 3: 輸入驗證邏輯

- [x] **VALID-1** 建立參數驗證類別 `ParameterValidator`
  - [x] 定義 `ValidationRules` 介面
  - [x] 定義 `ValidationResult` 介面
  - [x] 實作數值範圍檢查方法
  - [x] 實作數值格式檢查方法
  - [x] 實作陣列參數驗證方法

- [x] **VALID-2** 實作各參數驗證規則
  - [x] 基礎傷害驗證（0.01 ~ 9999999999）
  - [x] 百分比加成驗證（-99% ~ 9999%）
  - [x] 護甲值驗證（0 ~ 9999999999）
  - [x] 穿甲效果驗證（0% ~ 999.99%，有效上限 75%）
  - [x] 精度驗證（小數點後2位）

- [x] **VALID-3** 單元測試 - 驗證邏輯
  - [x] 測試有效輸入值
  - [x] 測試無效輸入值（超出範圍）
  - [x] 測試格式錯誤（非數值、無效字元）
  - [x] 測試邊界值（最小值、最大值）
  - [x] 測試精度限制

### 🎨 Phase 4: UI 元件開發

- [x] **UI-1** 建立共用輸入元件
  - [x] `NumberInput` 數值輸入元件
    - [x] 支援 min/max 限制
    - [x] 支援精度設定（小數點位數）
    - [x] 支援前綴/後綴顯示（如 % 符號）
    - [x] 整合即時驗證
  - [x] `DynamicNumberList` 動態數值列表元件
    - [x] 支援新增/移除項目
    - [x] 支援批次驗證
    - [x] 支援拖拽排序（可選）

- [x] **UI-2** 建立傷害計算表單 `DamageCalculatorForm`
  - [x] 基礎參數輸入區塊
    - [x] 基礎傷害輸入
    - [x] 基礎暴擊傷害加成輸入
  - [x] 加成參數輸入區塊
    - [x] 增加傷害動態列表
    - [x] 暴擊傷害加成動態列表
  - [x] 護甲參數輸入區塊
    - [x] 敵人護甲值輸入
    - [x] 穿甲效果動態列表
  - [x] 減免參數輸入區塊
    - [x] 傷害減免動態列表
    - [x] 承受傷害加成動態列表
  - [x] 操作按鈕區塊
    - [x] 重置按鈕（含確認提示）
    - [x] 載入範例按鈕（範例 1 & 2）

- [x] **UI-3** 建立計算結果顯示 `CalculationResults`
  - [x] 最終傷害顯示
    - [x] 大字體顯示最終數值
    - [x] 精度格式化（小數點後2位）
  - [x] 計算步驟顯示
    - [x] 每個步驟的名稱與公式
    - [x] 每個步驟的輸入值與結果
    - [x] 步驟間的流程指示
  - [x] 範例對照顯示
    - [x] 與文檔範例的差異比較
    - [x] 差異程度的視覺指示（顏色）

### 📄 Phase 5: 頁面整合

- [ ] **PAGE-1** 建立計算器頁面 `pages/tools/damage-calculator.vue`
  - [ ] 頁面佈局設計（左右分欄：輸入 vs 結果）
  - [ ] 響應式設計適配
  - [ ] SEO meta 標籤設定
  - [ ] 頁面標題與描述

- [ ] **PAGE-2** 整合所有元件
  - [ ] 表單與結果的資料流同步
  - [ ] 即時計算觸發邏輯（防抖 300ms）
  - [ ] 錯誤處理與使用者提示
  - [ ] 載入狀態處理

- [ ] **PAGE-3** 樣式與 UX 優化
  - [ ] 使用 shadcn/ui 設計系統
  - [ ] 一致的間距與色彩
  - [ ] 互動狀態設計（hover, focus, disabled）
  - [ ] 錯誤狀態視覺指示

### 🧪 Phase 6: 功能驗證

- [ ] **TEST-1** 手動功能測試
  - [ ] 完整計算流程測試
  - [ ] 範例載入功能測試
  - [ ] 錯誤處理測試
  - [ ] 響應式佈局測試

### 🚀 Phase 7: 部署與文檔

- [ ] **DOC-1** 建立使用說明文檔
  - [ ] 功能介紹與使用方式
  - [ ] 計算公式說明
  - [ ] 範例操作步驟

- [ ] **DOC-2** 建立開發者文檔
  - [ ] API 文檔（型別定義）
  - [ ] 元件使用指南
  - [ ] 測試覆蓋率報告

- [ ] **DEPLOY-1** 生產環境部署
  - [ ] 建置設定檢查
  - [ ] 效能測試（載入時間 < 2秒）
  - [ ] 瀏覽器相容性測試

## 🔗 任務相依性

### 關鍵路徑

```
ENV-1 → CALC-1 → CALC-2 → CALC-3
                    ↓
VALID-1 → VALID-2 → VALID-3
                    ↓
UI-1 → UI-2 → UI-3 → PAGE-1 → PAGE-2 → PAGE-3
                                ↓
                      TEST-1 → TEST-2
                                ↓
                      DOC-1 → DOC-2 → DEPLOY-1
```

### 並行開發可能

- **CALC-3** 與 **VALID-1** 可並行進行
- **UI-1** 開發時可先使用 mock 資料
- **DOC-1** 可在 **PAGE-2** 完成後開始

## 📝 檔案結構規劃

```
damage-calculator/
├── lib/
│   ├── calculator.ts           # DamageCalculator 主類別
│   ├── validator.ts            # ParameterValidator 驗證類別
│   └── types.ts               # 型別定義
├── components/
│   ├── ui/
│   │   ├── NumberInput.vue    # 數值輸入元件
│   │   └── DynamicNumberList.vue # 動態列表元件
│   ├── DamageCalculatorForm.vue   # 主表單元件
│   └── CalculationResults.vue     # 結果顯示元件
├── pages/tools/
│   └── damage-calculator.vue      # 計算器頁面
├── tests/
│   ├── calculator.test.ts         # 計算邏輯測試
│   └── validator.test.ts          # 驗證邏輯測試
└── docs/
    ├── usage.md                   # 使用說明
    └── api.md                     # API 文檔
```

## ⚡ 開發環境配置

### Vitest 設定檔案

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'jsdom',
    globals: true,
    coverage: {
      reporter: ['text', 'html'],
      exclude: ['tests/**', 'node_modules/**']
    }
  },
  resolve: {
    alias: {
      '~': new URL('./', import.meta.url).pathname,
      '@': new URL('./', import.meta.url).pathname
    }
  }
});
```

### Package.json 測試腳本

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:watch": "vitest --watch"
  },
  "devDependencies": {
    "vitest": "^1.0.0",
    "@vitest/ui": "^1.0.0",
    "@vue/test-utils": "^2.4.0",
    "jsdom": "^23.0.0",
    "c8": "^8.0.0"
  }
}
```

## 🎯 驗收標準

### 功能完整性

- [ ] 所有計算公式實作正確
- [ ] 文檔範例計算結果完全一致
- [ ] 輸入驗證涵蓋所有邊界情況
- [ ] UI 互動流程順暢無阻

### 程式碼品質

- [ ] 單元測試覆蓋率 > 90%
- [ ] 所有 TypeScript 型別正確定義
- [ ] ESLint 檢查無錯誤
- [ ] Prettier 格式化一致

### 效能標準

- [ ] 計算響應時間 < 100ms
- [ ] 頁面載入時間 < 2秒
- [ ] 記憶體使用合理（無記憶體洩漏）

### 使用者體驗

- [ ] 響應式設計適配桌面與平板
- [ ] 錯誤提示清楚明確
- [ ] 操作流程直觀易懂
- [ ] 視覺設計與專案風格一致

## 📊 估時評估

| Phase    | 預估工時    | 備註                       |
| -------- | ----------- | -------------------------- |
| Phase 1  | 2 小時      | 環境設置相對簡單           |
| Phase 2  | 8 小時      | 核心邏輯，需仔細實作與測試 |
| Phase 3  | 4 小時      | 驗證邏輯相對直接           |
| Phase 4  | 12 小時     | UI 開發工時較多            |
| Phase 5  | 6 小時      | 頁面整合與優化             |
| Phase 6  | 4 小時      | 整合測試                   |
| Phase 7  | 2 小時      | 文檔與部署                 |
| **總計** | **38 小時** | 約 5 個工作天              |

## 📚 Rules & Tips

### 發現與學習

1. **文檔計算錯誤發現**：
   - damage.md 中範例 2 的計算結果有誤
   - 文檔中顯示：1000 × 1.3 × 1.5 × 0.625 × 0.9 × 1.2 ≈ 1096.88
   - 實際計算：1000 × 1.3 × 1.5 × 0.625 × 0.9 × 1.2 = 1316.25
   - 推測文檔中漏算了承受傷害加成的 ×1.2 步驟

2. **參數格式統一**：
   - 所有百分比參數（damageIncreases, baseCritDamage, critDamageModifiers 等）都應使用百分比格式（如 30 代表 30%）
   - 計算時統一除以 100 轉換為小數進行運算
   - 這樣確保參數輸入和顯示的一致性

3. **精度處理**：
   - 最終傷害結果四捨五入到小數點後 2 位
   - 中間計算步驟保持完整精度，避免累積誤差
   - 護甲減免率計算需要高精度（如 600/1100 = 0.5454545...）

4. **測試覆蓋率完整性**：
   - CALC-3 任務已完成全面的單元測試覆蓋
   - 包含 24 個測試案例，涵蓋基礎計算、邊界值、精度處理等
   - 特別注重極大數值的處理（如護甲值 9999999999 會導致最終傷害四捨五入為 0）
   - 測試中發現護甲減免在極大護甲值時會產生接近 0 的結果，符合預期設計

5. **穿甲效果驗證邏輯**：
   - 穿甲效果有雙重驗證：範圍驗證（0% ~ 999.99%）和有效上限驗證（75%）
   - 有效穿甲率計算：總穿甲效果 / (總穿甲效果 + 100)
   - 單一穿甲效果的最大允許值為 300%（剛好達到 75% 有效穿甲率）
   - 超過 300% 的單一穿甲效果會觸發有效上限驗證失敗，即使數值在 0-999.99% 範圍內

6. **VALID-3 完整驗證測試覆蓋**：
   - 測試覆蓋率達到 100%，包含 40 個針對驗證邏輯的詳細測試案例
   - 驗證測試分為 5 大類：有效輸入值、無效輸入值（超出範圍）、格式錯誤、邊界值、精度限制
   - 特別針對護甲穿甲的有效上限進行複雜情境測試，確保各種穿甲組合的正確驗證
   - 發現並修正了測試案例中的邏輯錯誤：單一 999.99% 穿甲效果會產生 90.91% 有效穿甲率，超過 75% 上限
   - 驗證邏輯對所有參數類型（基礎傷害、百分比修飾符、護甲值、穿甲效果）都有完整的格式和範圍檢查

7. **UI-3 結果顯示元件設計模式**：
   - 結果顯示元件應採用漸進式資訊揭露，從最終結果到詳細步驟再到範例對照
   - 大數值顯示需考慮響應式設計，在不同螢幕尺寸下都要保持可讀性
   - 計算步驟的視覺化應包含編號、公式代碼區塊、輸入輸出數值、以及流程指示箭頭
   - 範例對照功能需要智能差異分析，根據差異百分比顯示不同的視覺指示顏色
   - 文檔校正提醒功能有助於發現並註記已知的文檔錯誤，提升工具的實用性
